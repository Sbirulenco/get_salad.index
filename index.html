<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Device Info (Consent needed)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 900px; margin: 32px auto; line-height: 1.4; }
    pre { background: #f6f8fa; padding: 16px; border-radius: 8px; overflow: auto; }
    .consent { padding: 12px 16px; border-radius: 8px; margin: 16px 0; background: #fff8e1; border: 1px solid #ffe082; }
    .hidden { display: none; }
    button { padding: 10px 16px; border: 0; border-radius: 8px; cursor: pointer; }
    #readable-info p { margin: 4px 0; }
  </style>
</head>
<body>
  <h1>Device Info Collection (with consent)</h1>
  <p class="consent">
    This page collects your browser & device characteristics (e.g., OS, screen, GPU, network) and displays them here. By clicking “I Agree & Start”, you consent to this collection.
  </p>

  <button id="start">I Agree & Start</button>
  <div id="status"></div>

  <h2>Your Info (JSON)</h2>
  <pre id="output">Not started yet…</pre>

  <h2>Your Info (Readable)</h2>
  <div id="readable-info"></div>

  <script>
    function safeGet(fn, fallback=null){ try { return fn(); } catch { return fallback; } }

    async function estimateRefreshRate(samples=60){
      return new Promise(resolve=>{
        let count=0, start=null;
        function step(ts){
          if(start===null){ start=ts; count=0; }
          else if(count>=samples){
            const elapsed=ts-start;
            const fps = count*1000/elapsed;
            resolve(Math.round(fps));
            return;
          }
          count++; requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      });
    }

    function getWebGLInfo(){
      const canvas = document.createElement("canvas");
      const gl = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");
      if(!gl) return null;
      const dbg = gl.getExtension("WEBGL_debug_renderer_info");
      return {
        vendor: dbg ? gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL) : 'Unknown',
        renderer: dbg ? gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL) : 'Unknown',
        version: gl.getParameter(gl.VERSION),
        shadingLanguage: gl.getParameter(gl.SHADING_LANGUAGE_VERSION)
      };
    }

    async function detectAdBlock(){
      return new Promise(res=>{
        const bait=document.createElement('div');
        bait.className='adsbox banner ad-banner adunit ad-ads adzone sponsored';
        bait.style.height='1px'; bait.style.width='1px'; bait.style.position='absolute'; bait.style.left='-10000px';
        document.body.appendChild(bait);
        setTimeout(()=>{
          const blocked = bait.offsetHeight === 0 || bait.clientHeight === 0 || bait.offsetParent === null;
          bait.remove(); res(blocked);
        }, 120);
      });
    }

    async function getIP(){
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const json = await res.json();
        return json.ip;
      } catch {
        return 'Unknown';
      }
    }

    async function collect(){
      const nav = navigator;
      const uaData = nav.userAgentData || null;
      const battery = nav.getBattery ? await nav.getBattery().catch(()=>null) : null;
      const refresh = await estimateRefreshRate(90).catch(()=>null);
      const adblock = await detectAdBlock().catch(()=>null);
      const webgl = getWebGLInfo();
      const ip = await getIP();

      const data = {
        timestamp: new Date().toISOString(),
        ip: ip,
        locationHref: location.href,
        referrer: document.referrer || null,

        // Browser / OS
        userAgent: nav.userAgent,
        platform: safeGet(()=>nav.platform),
        userAgentData: uaData ? {
          mobile: uaData.mobile,
          platform: uaData.platform,
          brands: uaData.brands
        } : null,

        // Languages & time
        languages: nav.languages || [nav.language],
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        doNotTrack: nav.doNotTrack || null,

        // Hardware hints
        hardwareConcurrency: nav.hardwareConcurrency || null,
        deviceMemory: nav.deviceMemory || null,

        // Screen / display
        screen: {
          width: screen.width,
          height: screen.height,
          availWidth: screen.availWidth,
          availHeight: screen.availHeight,
          colorDepth: screen.colorDepth,
          pixelDepth: screen.pixelDepth,
          devicePixelRatio: window.devicePixelRatio || 1,
          estimatedRefreshRateHz: refresh
        },

        // Viewport & orientation
        viewport: { width: window.innerWidth, height: window.innerHeight },
        orientation: screen.orientation ? screen.orientation.type : 'Unknown',

        // Network
        online: nav.onLine,
        effectiveNetwork: nav.connection ? nav.connection.effectiveType : 'Unknown',

        // Preferences
        prefersDark: matchMedia('(prefers-color-scheme: dark)').matches,
        prefersReducedMotion: matchMedia('(prefers-reduced-motion: reduce)').matches,

        // Features
        touchSupport: 'ontouchstart' in window || (nav.maxTouchPoints > 0),
        pluginsCount: (nav.plugins && nav.plugins.length) || null,
        storage: {
          localStorage: !!window.localStorage,
          sessionStorage: !!window.sessionStorage,
          cookiesEnabled: nav.cookieEnabled
        },

        // Battery
        battery: battery ? { charging: battery.charging, level: battery.level } : null,

        // Graphics
        webgl: webgl,

        // Heuristics
        adBlockLikely: adblock
      };

      return data;
    }

    function displayReadableInfo(data) {
      const container = document.getElementById('readable-info');
      container.innerHTML = `
        <p><strong>Public IP:</strong> ${data.ip}</p>
        <p><strong>Browser:</strong> ${data.userAgent}</p>
        <p><strong>Platform:</strong> ${data.platform}</p>
        <p><strong>Languages:</strong> ${data.languages.join(', ')}</p>
        <p><strong>Timezone:</strong> ${data.timezone}</p>
        <p><strong>Screen Resolution:</strong> ${data.screen.width}x${data.screen.height}</p>
        <p><strong>Available Screen:</strong> ${data.screen.availWidth}x${data.screen.availHeight}</p>
        <p><strong>Estimated Refresh Rate:</strong> ${data.screen.estimatedRefreshRateHz} Hz</p>
        <p><strong>GPU Vendor:</strong> ${data.webgl.vendor}</p>
        <p><strong>GPU Renderer:</strong> ${data.webgl.renderer}</p>
        <p><strong>WebGL Version:</strong> ${data.webgl.version}</p>
        <p><strong>Shading Language:</strong> ${data.webgl.shadingLanguage}</p>
        <p><strong>Touch Support:</strong> ${data.touchSupport ? 'Yes' : 'No'}</p>
        <p><strong>Battery:</strong> ${data.battery ? (data.battery.level*100)+'%' : 'Not available'}</p>
        <p><strong>Ad Block Likely:</strong> ${data.adBlockLikely ? 'Yes' : 'No'}</p>
        <p><strong>Online:</strong> ${data.online ? 'Yes' : 'No'}</p>
        <p><strong>Network Type:</strong> ${data.effectiveNetwork}</p>
        <p><strong>Viewport:</strong> ${data.viewport.width}x${data.viewport.height}</p>
        <p><strong>Screen Orientation:</strong> ${data.orientation}</p>
        <p><strong>Dark Mode:</strong> ${data.prefersDark ? 'Yes' : 'No'}</p>
        <p><strong>Reduced Motion:</strong> ${data.prefersReducedMotion ? 'Yes' : 'No'}</p>
      `;
    }

    document.getElementById('start').addEventListener('click', async ()=> {
      document.getElementById('status').textContent = "Collecting…";
      const data = await collect();
      document.getElementById('output').textContent = JSON.stringify(data, null, 2);
      displayReadableInfo(data);
    });
  </script>
</body>
</html>
