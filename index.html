<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Device Info (Consent needed)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 900px; margin: 32px auto; line-height: 1.4; }
    pre { background: #f6f8fa; padding: 16px; border-radius: 8px; overflow: auto; }
    .consent { padding: 12px 16px; border-radius: 8px; margin: 16px 0; background: #fff8e1; border: 1px solid #ffe082; }
    .hidden { display: none; }
    button { padding: 10px 16px; border: 0; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Device Info Collection (with consent)</h1>
  <p class="consent">
    This page collects your browser & device characteristics (e.g., OS, screen, timezone, GPU, language) and sends them with your IP address to the site owner’s server for demonstration.
    By clicking “I Agree & Start”, you consent to this collection.
  </p>

  <button id="start">I Agree & Start</button>
  <div id="status"></div>
  <h2>Your Info (also sent to server)</h2>
  <pre id="output">Not started yet…</pre>

  <script>
    // === Replace this AFTER you create the Codespaces server (section B) ===
    const LOG_ENDPOINT = "https://REPLACE_WITH_CODESPACES_URL/log";

    function safeGet(fn, fallback=null){ try { return fn(); } catch { return fallback; } }

    async function estimateRefreshRate(samples=60){
      return new Promise(resolve=>{
        let count=0, start=null;
        function step(ts){
          if(start===null){ start=ts; count=0; }
          else if(count>=samples){
            const elapsed=ts-start;
            const fps = count*1000/elapsed;
            resolve(Math.round(fps));
            return;
          }
          count++; requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      });
    }

    async function detectAdBlock(){
      return new Promise(res=>{
        const bait=document.createElement('div');
        bait.className='adsbox banner ad-banner adunit ad-ads adzone sponsored';
        bait.style.height='1px'; bait.style.width='1px'; bait.style.position='absolute'; bait.style.left='-10000px';
        document.body.appendChild(bait);
        setTimeout(()=>{
          const blocked = bait.offsetHeight === 0 || bait.clientHeight === 0 || bait.offsetParent === null;
          bait.remove(); res(blocked);
        }, 120);
      });
    }

    function getWebGLInfo(){
      const canvas = document.createElement("canvas");
      const gl = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");
      if(!gl) return null;
      const info = {};
      const dbg = gl.getExtension("WEBGL_debug_renderer_info");
      info.vendor = dbg ? gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL) : null;
      info.renderer = dbg ? gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL) : null;
      info.shadingLanguage = gl.getParameter(gl.SHADING_LANGUAGE_VERSION);
      info.version = gl.getParameter(gl.VERSION);
      return info;
    }

    async function collect(){
      const nav = navigator;
      const uaData = nav.userAgentData || null;

      const battery = nav.getBattery ? await nav.getBattery().catch(()=>null) : null;
      const refresh = await estimateRefreshRate(90).catch(()=>null);
      const adblock = await detectAdBlock().catch(()=>null);
      const webgl = getWebGLInfo();

      const data = {
        timestamp: new Date().toISOString(),
        locationHref: location.href,
        referrer: document.referrer || null,

        // Browser / OS
        userAgent: nav.userAgent,
        platform: safeGet(()=>nav.platform),
        userAgentData: uaData ? {
          mobile: uaData.mobile,
          platform: uaData.platform,
          brands: uaData.brands
        } : null,

        // Languages & time
        languages: nav.languages || [nav.language],
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        doNotTrack: nav.doNotTrack || null,

        // Hardware hints (browser-limited)
        hardwareConcurrency: nav.hardwareConcurrency || null,
        deviceMemory: nav.deviceMemory || null, // (GB) Chrome only

        // Screen / display
        screen: {
          width: screen.width,
          height: screen.height,
          availWidth: screen.availWidth,
          availHeight: screen.availHeight,
          colorDepth: screen.colorDepth,
          pixelDepth: screen.pixelDepth,
          devicePixelRatio: window.devicePixelRatio || 1,
          estimatedRefreshRateHz: refresh
        },

        // Preferences
        prefersDark: matchMedia('(prefers-color-scheme: dark)').matches,
        prefersReducedMotion: matchMedia('(prefers-reduced-motion: reduce)').matches,

        // Features
        touchSupport: 'ontouchstart' in window || (nav.maxTouchPoints > 0),
        pluginsCount: (nav.plugins && nav.plugins.length) || null,
        storage: {
          localStorage: !!window.localStorage,
          sessionStorage: !!window.sessionStorage,
          cookiesEnabled: nav.cookieEnabled
        },

        // Battery
        battery: battery ? {
          charging: battery.charging,
          level: battery.level
        } : null,

        // Graphics
        webgl: webgl,

        // Heuristics
        adBlockLikely: adblock
      };

      return data;
    }

    async function send(data){
      if(!LOG_ENDPOINT.includes("REPLACE_WITH_CODESPACES_URL")){
        try{
          const r = await fetch(LOG_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });
          return await r.json();
        }catch(e){
          return { ok:false, error:String(e) };
        }
      } else {
        return { ok:false, error:"LOG_ENDPOINT not set yet." };
      }
    }

    document.getElementById('start').addEventListener('click', async ()=>{
      document.getElementById('status').textContent = "Collecting…";
      const data = await collect();
      document.getElementById('output').textContent = JSON.stringify(data, null, 2);
      const res = await send(data);
      document.getElementById('status').textContent = res && res.ok ? "Sent to server ✔" : ("Not sent: " + (res.error || 'unknown error'));
    });
  </script>
</body>
</html>