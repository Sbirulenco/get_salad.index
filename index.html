<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Device Info Report</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 900px; margin: 32px auto; line-height: 1.4; }
    pre { background: #f6f8fa; padding: 16px; border-radius: 8px; overflow: auto; }
    .consent { padding: 12px 16px; border-radius: 8px; margin: 16px 0; background: #fff8e1; border: 1px solid #ffe082; }
    button { padding: 10px 16px; border: 0; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Device Info Report (Consent Needed)</h1>
  <p class="consent">
    This page collects your browser & device info (OS, screen, GPU, battery, preferences) and sends it to the server for demonstration.
    By clicking “Generate My Device Report”, you consent to this collection.
  </p>

  <button id="start">Generate My Device Report</button>
  <div id="status"></div>
  <h2>Your Report</h2>
  <pre id="output">Not started yet…</pre>

  <script>
    const LOG_ENDPOINT = "http://localhost:3000/log"; // Make sure your server is running

    function safeGet(fn, fallback=null){ try { return fn(); } catch { return fallback; } }

    async function estimateRefreshRate(samples=60){
      return new Promise(resolve=>{
        let count=0, start=null;
        function step(ts){
          if(start===null){ start=ts; count=0; }
          else if(count>=samples){
            const elapsed=ts-start;
            const fps = count*1000/elapsed;
            resolve(Math.round(fps));
            return;
          }
          count++; requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      });
    }

    async function detectAdBlock(){
      return new Promise(res=>{
        const bait=document.createElement('div');
        bait.className='adsbox banner ad-banner adunit ad-ads adzone sponsored';
        bait.style.height='1px'; bait.style.width='1px'; bait.style.position='absolute'; bait.style.left='-10000px';
        document.body.appendChild(bait);
        setTimeout(()=>{
          const blocked = bait.offsetHeight === 0 || bait.clientHeight === 0 || bait.offsetParent === null;
          bait.remove(); res(blocked);
        }, 120);
      });
    }

    function getWebGLInfo(){
      const canvas = document.createElement("canvas");
      const gl = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");
      if(!gl) return null;
      const info = {};
      const dbg = gl.getExtension("WEBGL_debug_renderer_info");
      info.vendor = dbg ? gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL) : null;
      info.renderer = dbg ? gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL) : null;
      info.shadingLanguage = gl.getParameter(gl.SHADING_LANGUAGE_VERSION);
      info.version = gl.getParameter(gl.VERSION);
      return info;
    }

    async function collect(){
      const nav = navigator;
      const uaData = nav.userAgentData || null;

      const battery = nav.getBattery ? await nav.getBattery().catch(()=>null) : null;
      const refresh = await estimateRefreshRate(90).catch(()=>null);
      const adblock = await detectAdBlock().catch(()=>null);
      const webgl = getWebGLInfo();

      return {
        timestamp: new Date().toISOString(),
        userAgent: nav.userAgent,
        platform: safeGet(()=>nav.platform),
        userAgentData: uaData ? { mobile: uaData.mobile, platform: uaData.platform, brands: uaData.brands } : null,
        languages: nav.languages || [nav.language],
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        doNotTrack: nav.doNotTrack || null,
        hardwareConcurrency: nav.hardwareConcurrency || null,
        deviceMemory: nav.deviceMemory || null,
        screen: {
          width: screen.width,
          height: screen.height,
          availWidth: screen.availWidth,
          availHeight: screen.availHeight,
          colorDepth: screen.colorDepth,
          pixelDepth: screen.pixelDepth,
          devicePixelRatio: window.devicePixelRatio || 1,
          estimatedRefreshRateHz: refresh
        },
        prefersDark: matchMedia('(prefers-color-scheme: dark)').matches,
        prefersReducedMotion: matchMedia('(prefers-reduced-motion: reduce)').matches,
        touchSupport: 'ontouchstart' in window || (nav.maxTouchPoints > 0),
        pluginsCount: (nav.plugins && nav.plugins.length) || null,
        storage: {
          localStorage: !!window.localStorage,
          sessionStorage: !!window.sessionStorage,
          cookiesEnabled: nav.cookieEnabled
        },
        battery: battery ? { charging: battery.charging, level: battery.level } : null,
        webgl: webgl,
        adBlockLikely: adblock
      };
    }

    function makeReport(data){
      let report = "Device Report:\n\n";
      report += `Browser: ${data.userAgent}\n`;
      report += `Platform: ${data.platform || "Unknown"}\n`;
      const screen = data.screen || {};
      report += `Screen resolution: ${screen.width || "?"}x${screen.height || "?"}\n`;
      report += `Device Pixel Ratio: ${screen.devicePixelRatio || "?"}\n`;
      report += `Estimated Refresh Rate: ${screen.estimatedRefreshRateHz || "?"} Hz\n`;
      const webgl = data.webgl || {};
      report += `GPU Vendor: ${webgl.vendor || "Unknown"}\n`;
      report += `GPU Renderer: ${webgl.renderer || "Unknown"}\n`;
      if(data.battery) report += `Battery: ${data.battery.level*100}% ${data.battery.charging ? "(charging)" : "(not charging)"}\n`;
      report += `Prefers Dark Mode: ${data.prefersDark ? "Yes" : "No"}\n`;
      report += `Prefers Reduced Motion: ${data.prefersReducedMotion ? "Yes" : "No"}\n`;
      return report;
    }

    async function send(data){
      try{
        const r = await fetch(LOG_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        return await r.json();
      }catch(e){
        return { ok:false, error:String(e) };
      }
    }

    document.getElementById('start').addEventListener('click', async ()=>{
      document.getElementById('status').textContent = "Collecting…";
      const data = await collect();
      document.getElementById('output').textContent = makeReport(data);
      const res = await send(data);
      document.getElementById('status').textContent = res && res.ok ? "Sent to server ✔" : ("Not sent: " + (res.error || 'unknown error'));
    });
  </script>
</body>
</html>
